---
mongo:
    image: mongo

redis:
    image: redis

api:
    build: api
    links:
        - mongo
        - redis
    environment:
        - "NODE_ENV=production"
        - "PORT=9002"
        - "TOKEN_SECRET=taneli_on_kova_koodaamaan"
        - "MONGODB_URL=mongodb://mongo:27017/production"
        - "REDIS_HOST=redis"
        - "REDIS_PORT=6379"
        - "NEW_RELIC_ENABLED=false"
        - "NEW_RELIC_LOG=/home/teamboard/logs/relic-api.log"
    expose:
        - "9002"
    command: "/usr/bin/node /home/teamboard/teamboard-api/index.js"
    restart: "on-failure:10"

io:
    build: io
    links:
        - redis
        - api
    environment:
        - "NODE_ENV=production"
        - "PORT=9001"
        - "REDIS_HOST=redis"
        - "REDIS_PORT=6379"
        - "API_URL=http://api:9002/api"
        - "NEW_RELIC_ENABLED=false"
        - "NEW_RELIC_LOG=/home/teamboard/logs/relic-io.log"
    expose:
        - "9001"
    command: "/usr/bin/node /home/teamboard/teamboard-io/index.js"
    restart: "on-failure:10"

client:
    build: client-react
    environment:
        - "NODE_ENV=production"
        - "API_URL=http://localhost/api"
        - "IO_URL=http://localhost"
    restart: "on-failure:10"

haproxy:
    image: haproxy
    links:
        - api
        - io
        - client
    volumes:
        - "haproxy-conf/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro"
    ports:
        - "80:80"
